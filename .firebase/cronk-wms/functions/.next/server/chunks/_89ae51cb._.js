module.exports=[76701,e=>e.a(async(t,a)=>{try{var n=e.i(89171),s=e.i(46455),i=e.i(27817),r=t([s,i]);async function o(e){try{let t,{organizationId:a,importMode:r="unfulfilled",startDate:o,endDate:l,includeStatus:d="any"}=await e.json();if(!a)return n.NextResponse.json({success:!1,error:"Missing organization ID"},{status:400});try{t=(0,s.getAdminDb)()}catch(e){return console.error("Firebase Admin init error:",e),n.NextResponse.json({success:!1,error:"Server configuration error. Please contact support."},{status:500})}let c=await t.collection("organizations").doc(a).get();if(!c.exists)return n.NextResponse.json({success:!1,error:"Organization not found"},{status:404});let p=c.data(),u=p?.shopify;if(!u?.isConnected||!u?.accessToken)return n.NextResponse.json({success:!1,error:"Shopify not connected"},{status:400});let h=new URLSearchParams;h.set("limit","250"),"unfulfilled"===r?(h.set("status","open"),h.set("fulfillment_status","unfulfilled")):("date_range"===r&&(o&&h.set("created_at_min",new Date(o).toISOString()),l&&h.set("created_at_max",new Date(l).toISOString())),"any"!==d&&h.set("status",d));let m=t.collection("organizations").doc(a).collection("orders"),g=await m.where("shopifyId","!=",null).get(),_=new Map;g.docs.forEach(e=>{let t=e.data();t.shopifyId&&_.set(t.shopifyId,e.id)});let f=t.collection("organizations").doc(a).collection("products"),y=await f.get(),w=new Map;y.docs.forEach(e=>{let t=e.data();t.sku&&w.set(t.sku.toLowerCase(),e.id)});let R=t.collection("organizations").doc(a).collection("salesChannels"),v=await R.where("code","==","shopify").limit(1).get(),S="",b="Shopify",x="shopify";if(!v.empty){let e=v.docs[0];S=e.id;let t=e.data();b=t.name||"Shopify",x=t.code||"shopify"}let C=0,N=0,A=0,E=0,k=null;do{let e=`https://${u.storeName}.myshopify.com/admin/api/2024-01/orders.json?${h.toString()}`;k&&(e=`https://${u.storeName}.myshopify.com/admin/api/2024-01/orders.json?page_info=${k}&limit=250`);let t=await fetch(e,{headers:{"X-Shopify-Access-Token":u.accessToken,"Content-Type":"application/json"}});if(!t.ok){let e=await t.text();return console.error("Shopify fetch orders error:",e),n.NextResponse.json({success:!1,error:`Failed to fetch orders: ${t.status}`,imported:C,updated:A,skipped:0},{status:400})}let a=t.headers.get("link");if(k=null,a){let e=a.match(/<[^>]*page_info=([^>&]+)[^>]*>;\s*rel="next"/);e&&(k=e[1])}let s=(await t.json()).orders||[];for(let e of(E+=s.length,s)){let t=e.id.toString(),a=_.get(t),n=(e.line_items||[]).map(e=>{let t=e.sku?.toLowerCase();return{id:`li_${e.id}`,shopifyLineItemId:e.id.toString(),productId:t&&w.get(t)||null,shopifyProductId:e.product_id?.toString()||null,shopifyVariantId:e.variant_id?.toString()||null,sku:e.sku||"",name:e.name,title:e.title,variantTitle:e.variant_title||null,quantity:e.quantity,price:parseFloat(e.price)||0,totalDiscount:parseFloat(e.total_discount)||0,requiresShipping:e.requires_shipping,fulfillableQuantity:e.fulfillable_quantity,fulfillmentStatus:e.fulfillment_status||"unfulfilled",grams:e.grams,vendor:e.vendor,properties:e.properties||[],giftCard:e.gift_card,taxable:e.taxable,taxLines:(e.tax_lines||[]).map(e=>({title:e.title,price:parseFloat(e.price)||0,rate:e.rate}))}}),s=e.shipping_address?{firstName:e.shipping_address.first_name||"",lastName:e.shipping_address.last_name||"",name:e.shipping_address.name||"",company:e.shipping_address.company||null,address1:e.shipping_address.address1||"",address2:e.shipping_address.address2||null,city:e.shipping_address.city||"",province:e.shipping_address.province||"",provinceCode:e.shipping_address.province_code||"",country:e.shipping_address.country||"",countryCode:e.shipping_address.country_code||"",zip:e.shipping_address.zip||"",phone:e.shipping_address.phone||null,latitude:e.shipping_address.latitude,longitude:e.shipping_address.longitude}:null,i=e.billing_address?{firstName:e.billing_address.first_name||"",lastName:e.billing_address.last_name||"",name:e.billing_address.name||"",company:e.billing_address.company||null,address1:e.billing_address.address1||"",address2:e.billing_address.address2||null,city:e.billing_address.city||"",province:e.billing_address.province||"",provinceCode:e.billing_address.province_code||"",country:e.billing_address.country||"",countryCode:e.billing_address.country_code||"",zip:e.billing_address.zip||"",phone:e.billing_address.phone||null,latitude:e.billing_address.latitude,longitude:e.billing_address.longitude}:null,r=e.customer?{id:e.customer.id?.toString()||"",email:e.email||e.customer.email||"",firstName:e.customer.first_name||"",lastName:e.customer.last_name||"",phone:e.customer.phone||e.phone||null,ordersCount:e.customer.orders_count||0,totalSpent:parseFloat(e.customer.total_spent)||0,tags:e.customer.tags||""}:{id:"",email:e.email||"",firstName:"",lastName:"",phone:e.phone||null,ordersCount:0,totalSpent:0,tags:""},o=(e.fulfillments||[]).map(e=>({id:e.id.toString(),status:e.status,createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at),trackingCompany:e.tracking_company,trackingNumber:e.tracking_number,trackingNumbers:e.tracking_numbers||[],trackingUrl:e.tracking_url,trackingUrls:e.tracking_urls||[],shipmentStatus:e.shipment_status,lineItemIds:(e.line_items||[]).map(e=>e.id.toString())})),l=(e.refunds||[]).map(e=>({id:e.id.toString(),createdAt:new Date(e.created_at),processedAt:new Date(e.processed_at),note:e.note,lineItems:(e.refund_line_items||[]).map(e=>({id:e.id.toString(),lineItemId:e.line_item_id.toString(),quantity:e.quantity,restockType:e.restock_type,subtotal:parseFloat(e.subtotal)||0,totalTax:parseFloat(e.total_tax)||0})),transactions:(e.transactions||[]).map(e=>({id:e.id.toString(),amount:parseFloat(e.amount)||0,kind:e.kind,gateway:e.gateway,status:e.status}))})),d=(e.discount_codes||[]).map(e=>({code:e.code,amount:parseFloat(e.amount)||0,type:e.type})),c=(e.discount_applications||[]).map(e=>({type:e.type,title:e.title,description:e.description,value:parseFloat(e.value)||0,valueType:e.value_type,allocationMethod:e.allocation_method,targetSelection:e.target_selection,targetType:e.target_type})),p=(e.shipping_lines||[]).map(e=>({id:e.id.toString(),title:e.title,price:parseFloat(e.price)||0,code:e.code,source:e.source,carrierIdentifier:e.carrier_identifier,requestedFulfillmentServiceId:e.requested_fulfillment_service_id})),u=(e.tax_lines||[]).map(e=>({title:e.title,price:parseFloat(e.price)||0,rate:e.rate})),h="pending";e.cancelled_at?h="cancelled":e.closed_at?h="completed":"fulfilled"===e.fulfillment_status?h="shipped":"partial"===e.fulfillment_status?h="partially_shipped":"paid"===e.financial_status&&(h="processing");let g={shopifyId:t,shopifyOrderNumber:`#${e.order_number}`,shopifyOrderName:e.name,status:h,fulfillmentStatus:e.fulfillment_status||"unfulfilled",paymentStatus:e.financial_status||"pending",customer:r,shippingAddress:s,billingAddress:i,lineItems:n,shippingLines:p,subtotal:parseFloat(e.subtotal_price)||0,shippingTotal:parseFloat(e.total_shipping_price_set?.shop_money?.amount)||0,taxTotal:parseFloat(e.total_tax)||0,discountTotal:parseFloat(e.total_discounts)||0,total:parseFloat(e.total_price)||0,currency:e.currency||"USD",totalWeight:e.total_weight||0,taxLines:u,discountCodes:d,discountApplications:c,fulfillments:o,refunds:l,shippingMethod:p[0]?.title||null,paymentGateway:e.gateway||null,paymentGatewayNames:e.payment_gateway_names||[],processingMethod:e.processing_method||null,note:e.note||null,noteAttributes:e.note_attributes||[],tags:e.tags?e.tags.split(",").map(e=>e.trim()):[],browserIp:e.browser_ip,landingSite:e.landing_site,referringSite:e.referring_site,sourceName:e.source_name,shopifyLocationId:e.location_id?.toString()||null,isTestOrder:e.test||!1,confirmed:e.confirmed||!1,shopifyCreatedAt:new Date(e.created_at),shopifyUpdatedAt:new Date(e.updated_at),shopifyProcessedAt:e.processed_at?new Date(e.processed_at):null,shopifyClosedAt:e.closed_at?new Date(e.closed_at):null,shopifyCancelledAt:e.cancelled_at?new Date(e.cancelled_at):null,cancelReason:e.cancel_reason||null,updatedAt:new Date,source:"shopify",channelId:S,channelCode:x,channelName:b,sourceDetails:{platform:"shopify",externalId:t,externalOrderNumber:e.name,importedAt:new Date}},f=parseFloat(e.total_price)||0;a?(await m.doc(a).update(g),A++):(await m.add({...g,createdAt:new Date}),C++,N+=f)}}while(k)if(await t.collection("organizations").doc(a).update({"shopify.lastSyncOrders":new Date}),S&&C>0)try{await R.doc(S).update({"stats.totalOrders":i.FieldValue.increment(C),"stats.pendingOrders":i.FieldValue.increment(C),"stats.totalRevenue":i.FieldValue.increment(N),"stats.lastOrderAt":new Date,"integration.lastSyncAt":new Date})}catch(e){console.error("Error updating channel stats:",e)}return n.NextResponse.json({success:!0,imported:C,updated:A,skipped:0,total:E})}catch(e){return console.error("Sync orders error:",e),n.NextResponse.json({success:!1,error:e.message||"Sync failed"},{status:500})}}[s,i]=r.then?(await r)():r,e.s(["POST",()=>o]),a()}catch(e){a(e)}},!1),98291,e=>e.a(async(t,a)=>{try{var n=e.i(47909),s=e.i(74017),i=e.i(96250),r=e.i(59756),o=e.i(61916),l=e.i(74677),d=e.i(69741),c=e.i(16795),p=e.i(87718),u=e.i(95169),h=e.i(47587),m=e.i(66012),g=e.i(70101),_=e.i(26937),f=e.i(10372),y=e.i(93695);e.i(52474);var w=e.i(220),R=e.i(76701),v=t([R]);[R]=v.then?(await v)():v;let x=new n.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/shopify/sync-orders/route",pathname:"/api/shopify/sync-orders",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/shopify/sync-orders/route.ts",nextConfigOutput:"",userland:R}),{workAsyncStorage:C,workUnitAsyncStorage:N,serverHooks:A}=x;function S(){return(0,i.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:N})}async function b(e,t,a){x.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/shopify/sync-orders/route";n=n.replace(/\/index$/,"")||"/";let i=await x.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:R,params:v,nextConfig:S,parsedUrl:b,isDraftMode:C,prerenderManifest:N,routerServerContext:A,isOnDemandRevalidate:E,revalidateOnlyGenerated:k,resolvedPathname:T,clientReferenceManifest:I,serverActionsManifest:D}=i,O=(0,d.normalizeAppPath)(n),F=!!(N.dynamicRoutes[O]||N.routes[T]),P=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,b,!1):t.end("This page could not be found"),null);if(F&&!C){let e=!!N.routes[T],t=N.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await P();throw new y.NoFallbackError}}let q=null;!F||x.isDev||C||(q=T,q="/index"===q?"/":q);let U=!0===x.isDev||!F,j=F&&!U;D&&I&&(0,l.setManifestsSingleton)({page:n,clientReferenceManifest:I,serverActionsManifest:D});let M=e.method||"GET",H=(0,o.getTracer)(),$=H.getActiveScopeSpan(),z={params:v,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n,s)=>x.onRequestError(e,t,n,s,A)},sharedContext:{buildId:R}},L=new c.NodeNextRequest(e),K=new c.NodeNextResponse(t),V=p.NextRequestAdapter.fromNodeNextRequest(L,(0,p.signalFromNodeResponse)(t));try{let i=async e=>x.handle(V,z).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=H.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=a.get("next.route");if(s){let t=`${M} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${n}`)}),l=!!(0,r.getRequestMeta)(e,"minimalMode"),d=async r=>{var o,d;let c=async({previousCacheEntry:s})=>{try{if(!l&&E&&k&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(r);e.fetchMetrics=z.renderOpts.fetchMetrics;let o=z.renderOpts.pendingWaitUntil;o&&a.waitUntil&&(a.waitUntil(o),o=void 0);let d=z.renderOpts.collectedTags;if(!F)return await (0,m.sendResponse)(L,K,n,z.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==z.renderOpts.collectedRevalidate&&!(z.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&z.renderOpts.collectedRevalidate,s=void 0===z.renderOpts.collectedExpire||z.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:z.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:s}}}}catch(t){throw(null==s?void 0:s.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:E})},!1,A),t}},p=await x.handleResponse({req:e,nextConfig:S,cacheKey:q,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:E,revalidateOnlyGenerated:k,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:l});if(!F)return null;if((null==p||null==(o=p.value)?void 0:o.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==p||null==(d=p.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",E?"REVALIDATED":p.isMiss?"MISS":p.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,g.fromNodeOutgoingHttpHeaders)(p.value.headers);return l&&F||u.delete(f.NEXT_CACHE_TAGS_HEADER),!p.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,_.getCacheControlHeader)(p.cacheControl)),await (0,m.sendResponse)(L,K,new Response(p.value.body,{headers:u,status:p.value.status||200})),null};$?await d($):await H.withPropagatedContext(e.headers,()=>H.trace(u.BaseServerSpan.handleRequest,{spanName:`${M} ${n}`,kind:o.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},d))}catch(t){if(t instanceof y.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:E})},!1,A),F)throw t;return await (0,m.sendResponse)(L,K,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>S,"routeModule",()=>x,"serverHooks",()=>A,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>N]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_89ae51cb._.js.map