{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 48, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/1TB%20SSD/inventory-app/lib/firebase-admin.ts"],"sourcesContent":["import { initializeApp, getApps, cert, App } from 'firebase-admin/app'\nimport { getFirestore, Firestore } from 'firebase-admin/firestore'\n\nlet adminApp: App | undefined\nlet adminDb: Firestore | undefined\n\nfunction getAdminApp(): App {\n  if (adminApp) {\n    return adminApp\n  }\n\n  const apps = getApps()\n  if (apps.length > 0) {\n    adminApp = apps[0]\n    return adminApp\n  }\n\n  // Initialize Firebase Admin\n  // For production, use environment variables\n  // For local development, you can use a service account JSON file\n\n  const projectId = process.env.FIREBASE_PROJECT_ID\n  const clientEmail = process.env.FIREBASE_CLIENT_EMAIL\n  const privateKey = process.env.FIREBASE_PRIVATE_KEY?.replace(/\\\\n/g, '\\n')\n\n  if (!projectId || !clientEmail || !privateKey) {\n    throw new Error(\n      'Firebase Admin SDK credentials not found. Please set FIREBASE_PROJECT_ID, FIREBASE_CLIENT_EMAIL, and FIREBASE_PRIVATE_KEY environment variables.'\n    )\n  }\n\n  adminApp = initializeApp({\n    credential: cert({\n      projectId,\n      clientEmail,\n      privateKey,\n    }),\n  })\n\n  return adminApp\n}\n\nexport function getAdminDb(): Firestore {\n  if (adminDb) {\n    return adminDb\n  }\n\n  getAdminApp()\n  adminDb = getFirestore()\n  return adminDb\n}\n\n// Export a lazy-initialized adminDb for convenience\nexport { getAdminDb as adminDb }\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;;;;;;AAEA,IAAI;AACJ,IAAI;AAEJ,SAAS;IACP,IAAI,UAAU;QACZ,OAAO;IACT;IAEA,MAAM,OAAO,IAAA,mNAAO;IACpB,IAAI,KAAK,MAAM,GAAG,GAAG;QACnB,WAAW,IAAI,CAAC,EAAE;QAClB,OAAO;IACT;IAEA,4BAA4B;IAC5B,4CAA4C;IAC5C,iEAAiE;IAEjE,MAAM,YAAY,QAAQ,GAAG,CAAC,mBAAmB;IACjD,MAAM,cAAc,QAAQ,GAAG,CAAC,qBAAqB;IACrD,MAAM,aAAa,QAAQ,GAAG,CAAC,oBAAoB,EAAE,QAAQ,QAAQ;IAErE,IAAI,CAAC,aAAa,CAAC,eAAe,CAAC,YAAY;QAC7C,MAAM,IAAI,MACR;IAEJ;IAEA,WAAW,IAAA,yNAAa,EAAC;QACvB,YAAY,IAAA,gNAAI,EAAC;YACf;YACA;YACA;QACF;IACF;IAEA,OAAO;AACT;AAEO,SAAS;IACd,IAAI,SAAS;QACX,OAAO;IACT;IAEA;IACA,UAAU,IAAA,oOAAY;IACtB,OAAO;AACT"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/1TB%20SSD/inventory-app/app/api/shopify/sync-orders/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { getAdminDb } from '@/lib/firebase-admin'\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { organizationId } = await request.json()\n\n    if (!organizationId) {\n      return NextResponse.json({ success: false, error: 'Missing organization ID' }, { status: 400 })\n    }\n\n    const adminDb = getAdminDb()\n\n    // Get Shopify credentials\n    const orgDoc = await adminDb.collection('organizations').doc(organizationId).get()\n    if (!orgDoc.exists) {\n      return NextResponse.json({ success: false, error: 'Organization not found' }, { status: 404 })\n    }\n\n    const orgData = orgDoc.data()\n    const shopify = orgData?.shopify\n\n    if (!shopify?.isConnected || !shopify?.accessToken) {\n      return NextResponse.json({ success: false, error: 'Shopify not connected' }, { status: 400 })\n    }\n\n    // Fetch unfulfilled orders from Shopify\n    const shopifyUrl = `https://${shopify.storeName}.myshopify.com/admin/api/2024-01/orders.json?status=open&fulfillment_status=unfulfilled&limit=250`\n\n    const response = await fetch(shopifyUrl, {\n      headers: {\n        'X-Shopify-Access-Token': shopify.accessToken,\n        'Content-Type': 'application/json',\n      },\n    })\n\n    if (!response.ok) {\n      const errorText = await response.text()\n      console.error('Shopify fetch orders error:', errorText)\n      return NextResponse.json({ success: false, error: 'Failed to fetch orders' }, { status: 400 })\n    }\n\n    const data = await response.json()\n    const shopifyOrders = data.orders || []\n\n    // Get existing orders by Shopify ID\n    const ordersRef = adminDb.collection('organizations').doc(organizationId).collection('orders')\n    const existingSnapshot = await ordersRef.where('shopifyId', '!=', null).get()\n    const existingByShopifyId = new Set<string>()\n    existingSnapshot.docs.forEach((docSnap) => {\n      const docData = docSnap.data()\n      if (docData.shopifyId) {\n        existingByShopifyId.add(docData.shopifyId)\n      }\n    })\n\n    // Get products for SKU matching\n    const productsRef = adminDb.collection('organizations').doc(organizationId).collection('products')\n    const productsSnapshot = await productsRef.get()\n    const productsBySku = new Map<string, string>()\n    productsSnapshot.docs.forEach((docSnap) => {\n      const docData = docSnap.data()\n      if (docData.sku) {\n        productsBySku.set(docData.sku.toLowerCase(), docSnap.id)\n      }\n    })\n\n    let imported = 0\n    let skipped = 0\n\n    for (const shopifyOrder of shopifyOrders) {\n      const shopifyId = shopifyOrder.id.toString()\n\n      // Skip if already imported\n      if (existingByShopifyId.has(shopifyId)) {\n        skipped++\n        continue\n      }\n\n      // Map line items\n      const lineItems = (shopifyOrder.line_items || []).map((item: any) => {\n        const sku = item.sku?.toLowerCase()\n        return {\n          id: `li_${item.id}`,\n          shopifyLineItemId: item.id.toString(),\n          productId: sku ? productsBySku.get(sku) || null : null,\n          shopifyProductId: item.product_id?.toString() || null,\n          shopifyVariantId: item.variant_id?.toString() || null,\n          sku: item.sku || '',\n          name: item.name,\n          variantTitle: item.variant_title || null,\n          quantity: item.quantity,\n          price: parseFloat(item.price) || 0,\n          totalDiscount: parseFloat(item.total_discount) || 0,\n          requiresShipping: item.requires_shipping,\n          fulfillableQuantity: item.fulfillable_quantity,\n          fulfillmentStatus: 'unfulfilled',\n        }\n      })\n\n      const shippingAddress = shopifyOrder.shipping_address || {}\n      const customer = shopifyOrder.customer || {}\n\n      const orderData = {\n        shopifyId,\n        shopifyOrderNumber: `#${shopifyOrder.order_number}`,\n        shopifyOrderName: shopifyOrder.name,\n\n        status: 'pending',\n        fulfillmentStatus: shopifyOrder.fulfillment_status || 'unfulfilled',\n        paymentStatus: shopifyOrder.financial_status === 'paid' ? 'paid' : 'pending',\n\n        customer: {\n          id: customer.id?.toString() || '',\n          email: shopifyOrder.email || '',\n          firstName: customer.first_name || '',\n          lastName: customer.last_name || '',\n          phone: customer.phone || null,\n        },\n\n        shippingAddress: {\n          firstName: shippingAddress.first_name || '',\n          lastName: shippingAddress.last_name || '',\n          company: shippingAddress.company || null,\n          address1: shippingAddress.address1 || '',\n          address2: shippingAddress.address2 || null,\n          city: shippingAddress.city || '',\n          province: shippingAddress.province || '',\n          provinceCode: shippingAddress.province_code || '',\n          country: shippingAddress.country || '',\n          countryCode: shippingAddress.country_code || '',\n          zip: shippingAddress.zip || '',\n          phone: shippingAddress.phone || null,\n        },\n\n        lineItems,\n\n        subtotal: parseFloat(shopifyOrder.subtotal_price) || 0,\n        shippingTotal:\n          parseFloat(shopifyOrder.total_shipping_price_set?.shop_money?.amount) || 0,\n        taxTotal: parseFloat(shopifyOrder.total_tax) || 0,\n        discountTotal: parseFloat(shopifyOrder.total_discounts) || 0,\n        total: parseFloat(shopifyOrder.total_price) || 0,\n        currency: shopifyOrder.currency || 'USD',\n\n        shippingMethod: shopifyOrder.shipping_lines?.[0]?.title || null,\n\n        note: shopifyOrder.note || null,\n        tags: shopifyOrder.tags ? shopifyOrder.tags.split(',').map((t: string) => t.trim()) : [],\n\n        shopifyCreatedAt: new Date(shopifyOrder.created_at),\n        createdAt: new Date(),\n        updatedAt: new Date(),\n        source: 'shopify',\n      }\n\n      await ordersRef.add(orderData)\n      imported++\n    }\n\n    // Update last sync time\n    await adminDb.collection('organizations').doc(organizationId).update({\n      'shopify.lastSyncOrders': new Date(),\n    })\n\n    return NextResponse.json({\n      success: true,\n      imported,\n      skipped,\n      total: shopifyOrders.length,\n    })\n  } catch (error) {\n    console.error('Sync orders error:', error)\n    return NextResponse.json({ success: false, error: 'Sync failed' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}